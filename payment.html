// Get parameters from URL
const urlParams = new URLSearchParams(window.location.search);
const orderId = urlParams.get('order');
const isWaitingMode = urlParams.get('wait') === 'true';

// Main load function
window.addEventListener('DOMContentLoaded', function() {
    if (isWaitingMode && orderId) {
        // Customer v·ª´a submit form, ƒëang wait processing
        showWaitingScreen();
        waitForOrderProcessing(orderId);
    } else if (orderId) {
        // Direct access v·ªõi order ID
        loadOrderData(orderId);
    } else {
        showError('Kh√¥ng t√¨m th·∫•y th√¥ng tin ƒë∆°n h√†ng!');
    }
});

// Show waiting screen
function showWaitingScreen() {
    document.body.innerHTML = `
        <div class="waiting-container">
            <div class="spinner"></div>
            <h2>üîÑ ƒêang x·ª≠ l√Ω ƒë∆°n h√†ng...</h2>
            <p>ƒê∆°n h√†ng: <strong>${orderId}</strong></p>
            <p>Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</p>
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
            <small>Th·ªùi gian x·ª≠ l√Ω: 5-10 gi√¢y</small>
        </div>
    `;
    
    // Animate progress bar
    animateProgress();
}

// Wait for order processing completion
async function waitForOrderProcessing(orderId) {
    let attempts = 0;
    const maxAttempts = 30; // 60 seconds max
    
    const checkInterval = setInterval(async () => {
        attempts++;
        updateProgress(attempts, maxAttempts);
        
        try {
            // Check if order is processed in n8n/GitHub
            const orderReady = await checkOrderStatus(orderId);
            
            if (orderReady) {
                clearInterval(checkInterval);
                // Remove wait param and reload with clean URL
                window.location.href = `?order=${orderId}`;
                return;
            }
            
            if (attempts >= maxAttempts) {
                clearInterval(checkInterval);
                showTimeoutError();
            }
            
        } catch (error) {
            console.error('Check status error:', error);
        }
        
    }, 2000); // Check every 2 seconds
}

// Check if order is ready
async function checkOrderStatus(orderId) {
    try {
        // Method 1: Check GitHub JSON
        const response = await fetch('/data/orders.json?' + Date.now());
        const database = await response.json();
        
        if (database.orders && database.orders[orderId]) {
            return true;
        }
        
        // Method 2: Check n8n endpoint (alternative)
        // const n8nResponse = await fetch(`https://your-n8n.app/webhook/check-order/${orderId}`);
        // return n8nResponse.ok;
        
        return false;
        
    } catch (error) {
        console.error('Status check failed:', error);
        return false;
    }
}

// Load actual order data (when processing done)
async function loadOrderData(orderId) {
    try {
        const response = await fetch('/data/orders.json?' + Date.now());
        const database = await response.json();
        
        if (!database.orders || !database.orders[orderId]) {
            throw new Error('Order not found');
        }
        
        const orderData = database.orders[orderId];
        displayOrderInfo(orderData);
        loadQRCode(orderData.qrImageUrl);
        
    } catch (error) {
        console.error('Load order error:', error);
        showError('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë∆°n h√†ng!');
    }
}

// Display order information
function displayOrderInfo(orderData) {
    document.body.innerHTML = `
        <div class="payment-container">
            <div class="order-info">
                <h1>üí≥ Thanh to√°n ƒë∆°n h√†ng</h1>
                <div class="order-details">
                    <p><strong>M√£ ƒë∆°n:</strong> ${orderData.orderId}</p>
                    <p><strong>Kh√≥a h·ªçc:</strong> ${orderData.courseName}</p>
                    <p><strong>S·ªë ti·ªÅn:</strong> ${orderData.amount.toLocaleString()} VND</p>
                    <p><strong>Email:</strong> ${orderData.email}</p>
                </div>
            </div>
            
            <div class="qr-section">
                <h3>Qu√©t m√£ QR ƒë·ªÉ thanh to√°n:</h3>
                <div id="qrLoading" class="qr-loading">
                    <div class="spinner"></div>
                    <p>ƒêang t·∫£i m√£ QR...</p>
                </div>
                <img id="qrImage" class="qr-image" style="display: none;" alt="QR Code">
                
                <div class="transfer-info">
                    <p><strong>N·ªôi dung chuy·ªÉn kho·∫£n:</strong></p>
                    <div class="transfer-content">${orderData.transferContent}</div>
                    <button onclick="copyTransferContent()" class="copy-btn">üìã Copy</button>
                </div>
            </div>
        </div>
    `;
}

// Utility functions
function updateProgress(current, max) {
    const progressBar = document.getElementById('progressBar');
    if (progressBar) {
        const percentage = (current / max) * 100;
        progressBar.style.width = percentage + '%';
    }
}

function animateProgress() {
    let width = 0;
    const interval = setInterval(() => {
        width += 2;
        const progressBar = document.getElementById('progressBar');
        if (progressBar && width <= 90) {
            progressBar.style.width = width + '%';
        } else {
            clearInterval(interval);
        }
    }, 200);
}

function showTimeoutError() {
    document.body.innerHTML = `
        <div class="error-container">
            <h2>‚è∞ Timeout</h2>
            <p>Qu√° tr√¨nh x·ª≠ l√Ω m·∫•t nhi·ªÅu th·ªùi gian h∆°n d·ª± ki·∫øn.</p>
            <button onclick="location.reload()" class="retry-btn">üîÑ Th·ª≠ l·∫°i</button>
            <p><small>Ho·∫∑c li√™n h·ªá support n·∫øu v·∫•n ƒë·ªÅ v·∫´n ti·∫øp di·ªÖn</small></p>
        </div>
    `;
}

function copyTransferContent() {
    const content = document.querySelector('.transfer-content').textContent;
    navigator.clipboard.writeText(content).then(() => {
        alert('ƒê√£ copy n·ªôi dung chuy·ªÉn kho·∫£n!');
    });
}
